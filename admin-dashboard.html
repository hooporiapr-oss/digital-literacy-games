<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <style>
        body { font-family: Arial; max-width: 1200px; margin: 20px auto; padding: 20px; background: #1a1a2e; color: #fff; }
        .box { background: #2a2a3e; padding: 20px; border-radius: 10px; margin: 20px 0; }
        input, select, textarea, button { padding: 10px; margin: 5px; font-size: 16px; }
        button { background: #ffd700; color: #000; border: none; cursor: pointer; font-weight: bold; border-radius: 5px; }
        button:hover { opacity: 0.8; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #444; }
        th { color: #ffd700; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .stat { background: #333; padding: 20px; border-radius: 10px; text-align: center; }
        .stat h3 { color: #888; font-size: 14px; margin-bottom: 10px; }
        .stat .num { font-size: 36px; color: #ffd700; font-weight: bold; }
        .badge { padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; }
        .badge.active { background: #10b981; }
        .badge.expired { background: #ef4444; }
        .badge.trial { background: #f59e0b; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div id="login" class="box">
        <h2>üîê Admin Login</h2>
        <input type="password" id="key" placeholder="Admin Key">
        <button onclick="doLogin()">Login</button>
        <p id="error" style="color:#ff4444; margin-top:10px;"></p>
    </div>

    <div id="dash" class="hidden">
        <div class="box">
            <h1>üëë Admin Dashboard</h1>
            <button onclick="doLogout()">Logout</button>
        </div>

        <div class="stats">
            <div class="stat"><h3>Total Licenses</h3><div class="num" id="s1">0</div></div>
            <div class="stat"><h3>Active Licenses</h3><div class="num" id="s2">0</div></div>
            <div class="stat"><h3>Students</h3><div class="num" id="s3">0</div></div>
            <div class="stat"><h3>Revenue</h3><div class="num" id="s4">$0</div></div>
        </div>

        <div class="box">
            <h2>üìã All Licenses</h2>
            <button onclick="loadLicenses()">Refresh</button>
            <table>
                <thead>
                    <tr><th>Key</th><th>Customer</th><th>Students</th><th>Price</th><th>Status</th><th>Expires</th></tr>
                </thead>
                <tbody id="list"></tbody>
            </table>
        </div>

        <div class="box">
            <h2>‚ûï Create License</h2>
            <form onsubmit="return createLic(event)">
                <div><input type="text" id="name" placeholder="Customer Name" required style="width:300px;"></div>
                <div><input type="email" id="email" placeholder="Email (optional)" style="width:300px;"></div>
                <div>
                    <label><input type="checkbox" id="trial" onchange="toggleTrial()"> FREE TRIAL</label>
                </div>
                <div>
                    <input type="number" id="count" min="25" value="25" required style="width:150px;">
                    <span id="hint">students (min 25)</span>
                </div>
                <div id="trialDays" class="hidden">
                    <select id="days">
                        <option value="7">7 days</option>
                        <option value="14">14 days</option>
                    </select>
                </div>
                <div><textarea id="note" placeholder="Notes (optional)" rows="3" style="width:400px;"></textarea></div>
                <div id="summary" style="background:#333; padding:15px; margin:10px 0; border-radius:8px;">
                    <strong>Total: <span id="total">$100.00</span></strong>
                </div>
                <button type="submit">Create License</button>
                <p id="createMsg" style="margin-top:10px;"></p>
            </form>
        </div>
    </div>

    <script>
    const API = 'https://akashic-academy-backend.onrender.com';
    let KEY = '';

    async function doLogin() {
        KEY = document.getElementById('key').value;
        try {
            const r = await fetch(API + '/api/admin/stats?adminKey=' + KEY);
            if (r.ok) {
                localStorage.setItem('adminKey', KEY);
                document.getElementById('login').classList.add('hidden');
                document.getElementById('dash').classList.remove('hidden');
                loadAll();
            } else {
                document.getElementById('error').textContent = 'Invalid key';
            }
        } catch(e) {
            document.getElementById('error').textContent = 'Connection failed';
        }
    }

    function doLogout() {
        localStorage.removeItem('adminKey');
        location.reload();
    }

    async function loadAll() {
        await loadStats();
        await loadLicenses();
    }

    async function loadStats() {
        const r = await fetch(API + '/api/admin/stats?adminKey=' + KEY);
        const d = await r.json();
        document.getElementById('s1').textContent = d.totalLicenses;
        document.getElementById('s2').textContent = d.activeLicenses;
        document.getElementById('s3').textContent = d.totalStudentsRegistered;
        document.getElementById('s4').textContent = '$' + d.totalRevenue;
    }

    async function loadLicenses() {
        const r = await fetch(API + '/api/admin/licenses?adminKey=' + KEY);
        const lics = await r.json();
        const html = lics.map(l => {
            const status = l.isValid ? '<span class="badge active">Active</span>' : '<span class="badge expired">Expired</span>';
            const trial = l.isTrial ? '<span class="badge trial">Trial</span>' : '';
            return `<tr>
                <td style="font-family:monospace;color:#ffd700;">${l.licenseKey}</td>
                <td>${l.customerName}</td>
                <td>${l.studentsUsed}/${l.studentCount}</td>
                <td>${l.isTrial ? 'FREE' : '$'+l.pricing.total}</td>
                <td>${status} ${trial}</td>
                <td>${new Date(l.expiresAt).toLocaleDateString()}</td>
            </tr>`;
        }).join('');
        document.getElementById('list').innerHTML = html || '<tr><td colspan="6">No licenses</td></tr>';
    }

    function toggleTrial() {
        const isTrial = document.getElementById('trial').checked;
        const count = document.getElementById('count');
        if (isTrial) {
            document.getElementById('trialDays').classList.remove('hidden');
            count.min = 1;
            count.max = 24;
            count.value = 10;
            document.getElementById('hint').textContent = 'students (1-24 for trial)';
            document.getElementById('total').textContent = 'FREE (7 days)';
        } else {
            document.getElementById('trialDays').classList.add('hidden');
            count.min = 25;
            count.max = 10000;
            count.value = 25;
            document.getElementById('hint').textContent = 'students (min 25)';
            updatePrice();
        }
    }

    function updatePrice() {
        const c = parseInt(document.getElementById('count').value) || 25;
        let p = 4;
        if (c >= 500) p = 2.5;
        else if (c >= 250) p = 3;
        else if (c >= 100) p = 3.5;
        document.getElementById('total').textContent = '$' + (c * p).toFixed(2);
    }

    document.getElementById('count').oninput = updatePrice;
    document.getElementById('days').onchange = function() {
        document.getElementById('total').textContent = 'FREE (' + this.value + ' days)';
    };

    async function createLic(e) {
        e.preventDefault();
        const msg = document.getElementById('createMsg');
        try {
            const r = await fetch(API + '/api/admin/licenses', {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'x-admin-key': KEY},
                body: JSON.stringify({
                    customerName: document.getElementById('name').value,
                    customerEmail: document.getElementById('email').value,
                    studentCount: parseInt(document.getElementById('count').value),
                    notes: document.getElementById('note').value,
                    isTrial: document.getElementById('trial').checked,
                    trialDays: document.getElementById('trial').checked ? parseInt(document.getElementById('days').value) : null
                })
            });
            const d = await r.json();
            if (r.ok) {
                msg.style.color = '#10b981';
                msg.textContent = '‚úÖ Created: ' + d.license.licenseKey;
                e.target.reset();
                toggleTrial(); // Reset trial state
                loadAll();
            } else {
                msg.style.color = '#ff4444';
                msg.textContent = '‚ùå ' + d.error;
            }
        } catch(err) {
            msg.style.color = '#ff4444';
            msg.textContent = '‚ùå ' + err.message;
        }
        return false;
    }

    // Auto-login if saved key exists
    window.onload = function() {
        const savedKey = localStorage.getItem('adminKey');
        if (savedKey) {
            document.getElementById('key').value = savedKey;
            doLogin();
        }
    };
    </script>
</body>
</html>
