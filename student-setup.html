<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Portal - Akashic Academy</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: 'Segoe UI', Arial, sans-serif; 
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); 
            color: #fff; 
            min-height: 100vh;
            padding: 20px;
        }
        
        .container { max-width: 500px; margin: 0 auto; }
        .container.wide { max-width: 900px; }
        
        .card {
            background: rgba(42, 42, 62, 0.95);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            margin-bottom: 20px;
        }
        
        .logo { font-size: 4rem; text-align: center; margin-bottom: 15px; }
        h1 { color: #ffd700; text-align: center; font-size: 1.8rem; margin-bottom: 10px; }
        .subtitle { color: #aaa; text-align: center; margin-bottom: 30px; }
        
        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block;
            color: #aaa;
            font-size: 13px;
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        
        input, select {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #444;
            border-radius: 10px;
            background: #1a1a2e;
            color: #fff;
            outline: none;
        }
        input:focus, select:focus { border-color: #ffd700; }
        input::placeholder { color: #666; }
        
        .code-input {
            font-size: 1.5rem;
            text-align: center;
            letter-spacing: 5px;
            text-transform: uppercase;
        }
        
        button {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            background: linear-gradient(135deg, #ffd700 0%, #ffaa00 100%);
            color: #000;
            margin-top: 10px;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(255,215,0,0.3); }
        button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        
        .btn-secondary {
            background: #444;
            color: #fff;
        }
        .btn-secondary:hover { background: #555; box-shadow: none; }
        
        .btn-play {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: #fff;
        }
        
        .message {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }
        .message.error { background: rgba(239,68,68,0.2); border: 1px solid #ef4444; color: #fca5a5; display: block; }
        .message.success { background: rgba(16,185,129,0.2); border: 1px solid #10b981; color: #6ee7b7; display: block; }
        
        .hidden { display: none !important; }
        
        .steps {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
        }
        .step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #666;
        }
        .step.active { background: #ffd700; color: #000; }
        .step.done { background: #10b981; color: #fff; }
        .step-line {
            width: 50px;
            height: 2px;
            background: #333;
            align-self: center;
        }
        .step-line.done { background: #10b981; }
        
        .class-info {
            background: #1a1a2e;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .class-info h3 { color: #ffd700; margin-bottom: 10px; }
        .class-info p { color: #aaa; font-size: 14px; }
        
        .divider {
            display: flex;
            align-items: center;
            margin: 25px 0;
            color: #666;
        }
        .divider::before, .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #444;
        }
        .divider span { padding: 0 15px; font-size: 14px; }
        
        .lang-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
        }
        .lang-toggle button {
            padding: 8px 16px;
            font-size: 14px;
            background: rgba(255,255,255,0.1);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 20px;
            width: auto;
        }
        
        /* Games Portal */
        .header {
            text-align: center;
            padding: 20px 0 30px;
        }
        .header h1 { font-size: 2rem; }
        
        .user-bar {
            background: rgba(255,215,0,0.1);
            border: 1px solid rgba(255,215,0,0.3);
            border-radius: 10px;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        .user-bar .welcome { color: #ffd700; font-weight: bold; }
        .user-bar .grade { color: #aaa; font-size: 14px; }
        .user-bar button { width: auto; padding: 10px 20px; margin: 0; }
        
        .filter-bar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 25px;
        }
        .filter-btn {
            padding: 10px 20px;
            background: #333;
            border: none;
            border-radius: 20px;
            color: #fff;
            cursor: pointer;
            font-size: 14px;
            width: auto;
            margin: 0;
        }
        .filter-btn:hover { background: #444; transform: none; box-shadow: none; }
        .filter-btn.active { background: #ffd700; color: #000; }
        
        .games-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .game-card {
            background: rgba(42, 42, 62, 0.9);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        .game-card:hover { 
            border-color: #ffd700; 
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }
        .game-card .icon { font-size: 3rem; margin-bottom: 15px; }
        .game-card h3 { color: #fff; margin-bottom: 8px; font-size: 1.1rem; }
        .game-card p { color: #888; font-size: 13px; margin-bottom: 15px; }
        .game-card .grade-badge {
            display: inline-block;
            background: rgba(255,215,0,0.2);
            color: #ffd700;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            margin-bottom: 15px;
        }
        .game-card button { 
            padding: 12px 25px;
            font-size: 14px;
        }
        
        /* Announcements */
        .announcements-banner {
            background: linear-gradient(135deg, #6366f1, #4f46e5);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .announcements-banner.high {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        .announcement-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        .announcement-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        .announcement-item .title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .announcement-item .message {
            opacity: 0.9;
            font-size: 14px;
        }
        
        /* Goals Section */
        .goals-section {
            background: rgba(42, 42, 62, 0.9);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .goals-section h3 {
            color: #ffd700;
            margin-bottom: 15px;
        }
        .goal-item {
            background: #1a1a2e;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
        }
        .goal-item .goal-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .goal-item .goal-title {
            font-weight: bold;
        }
        .goal-item .goal-status {
            font-size: 13px;
            color: #888;
        }
        .goal-item .goal-status.completed {
            color: #10b981;
        }
        .progress-bar {
            background: #333;
            border-radius: 10px;
            height: 10px;
            overflow: hidden;
        }
        .progress-bar .fill {
            background: linear-gradient(90deg, #ffd700, #ffaa00);
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s;
        }
        .progress-bar .fill.completed {
            background: linear-gradient(90deg, #10b981, #059669);
        }
        
        /* Assignments Section */
        .assignments-section {
            background: rgba(42, 42, 62, 0.9);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .assignments-section h3 {
            color: #ffd700;
            margin-bottom: 15px;
        }
        .assignment-item {
            background: #1a1a2e;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
        }
        .assignment-item .assignment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .assignment-item .assignment-title {
            font-weight: bold;
        }
        .assignment-item .due-date {
            font-size: 13px;
            color: #f59e0b;
        }
        .assignment-games {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .assignment-game {
            background: #2a2a3e;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .assignment-game.completed {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid #10b981;
        }
        .assignment-game .checkmark {
            color: #10b981;
        }
        
        /* Locked Game */
        .game-card.locked {
            opacity: 0.5;
            pointer-events: none;
        }
        .game-card.locked::after {
            content: 'üîí';
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5rem;
        }
        .game-card {
            position: relative;
        }
        
        /* Streak Display */
        .streak-banner {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .streak-banner .flame {
            font-size: 2.5rem;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .streak-info .streak-count {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .streak-info .streak-label {
            font-size: 13px;
            opacity: 0.9;
        }
        .streak-stats {
            margin-left: auto;
            text-align: right;
            font-size: 13px;
            opacity: 0.9;
        }
        
        /* Avatar & Settings */
        .user-bar {
            background: rgba(255,215,0,0.1);
            border: 1px solid rgba(255,215,0,0.3);
            border-radius: 10px;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .avatar-display {
            width: 50px;
            height: 50px;
            background: #1a1a2e;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            cursor: pointer;
            border: 2px solid #ffd700;
            transition: transform 0.2s;
        }
        .avatar-display:hover { transform: scale(1.1); }
        .user-bar .welcome { color: #ffd700; font-weight: bold; }
        .user-bar .grade { color: #aaa; font-size: 14px; }
        .user-bar .user-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .settings-btn {
            background: #333;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .settings-btn:hover { background: #444; }
        
        /* Avatar Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: #2a2a3e;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-header h2 { color: #ffd700; margin: 0; }
        .modal-close {
            background: none;
            border: none;
            color: #888;
            font-size: 1.5rem;
            cursor: pointer;
            width: auto;
            padding: 0;
        }
        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
        }
        .avatar-option {
            width: 100%;
            aspect-ratio: 1;
            background: #1a1a2e;
            border-radius: 10px;
            border: 2px solid transparent;
            cursor: pointer;
            font-size: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .avatar-option:hover { border-color: #666; transform: scale(1.05); }
        .avatar-option.selected { border-color: #ffd700; background: rgba(255,215,0,0.2); }
        
        /* Settings Modal */
        .settings-group {
            margin-bottom: 20px;
        }
        .settings-group label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            color: #fff;
        }
        .settings-group .toggle {
            position: relative;
            width: 50px;
            height: 26px;
        }
        .settings-group .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .settings-group .toggle .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #444;
            border-radius: 26px;
            transition: 0.3s;
        }
        .settings-group .toggle .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
        }
        .settings-group .toggle input:checked + .slider { background: #10b981; }
        .settings-group .toggle input:checked + .slider:before { transform: translateX(24px); }
        .volume-slider {
            width: 100%;
            margin-top: 10px;
        }
        
        /* Achievements Section */
        .achievements-section {
            background: rgba(42, 42, 62, 0.9);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .achievements-section h3 {
            color: #ffd700;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .achievements-section .progress-text {
            font-size: 14px;
            color: #aaa;
            font-weight: normal;
        }
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
        }
        .achievement-item {
            background: #1a1a2e;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            opacity: 0.4;
            transition: all 0.3s;
        }
        .achievement-item.earned {
            opacity: 1;
            border: 1px solid #ffd700;
        }
        .achievement-item .icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }
        .achievement-item .name {
            font-size: 12px;
            font-weight: bold;
            color: #fff;
        }
        .achievement-item .desc {
            font-size: 10px;
            color: #888;
            margin-top: 4px;
        }
        
        /* Stats Bar */
        .stats-bar {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .stat-item {
            background: rgba(42, 42, 62, 0.9);
            border-radius: 10px;
            padding: 15px 20px;
            text-align: center;
            flex: 1;
            min-width: 100px;
        }
        .stat-item .value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ffd700;
        }
        .stat-item .label {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
        
        /* Game Mode Toggle */
        .mode-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }
        .mode-btn {
            padding: 12px 25px;
            background: #333;
            border: 2px solid #444;
            border-radius: 25px;
            color: #888;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            width: auto;
        }
        .mode-btn:hover { border-color: #666; color: #fff; }
        .mode-btn.active {
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            border-color: #ffd700;
            color: #000;
        }
        .mode-btn.practice.active {
            background: linear-gradient(135deg, #6366f1, #4f46e5);
            border-color: #6366f1;
            color: #fff;
        }
        .mode-indicator {
            text-align: center;
            font-size: 13px;
            color: #888;
            margin-bottom: 15px;
        }
        .mode-indicator.practice { color: #6366f1; }
        .mode-indicator.scored { color: #ffd700; }
        
        .forgot-link {
            text-align: center;
            margin-top: 15px;
        }
        .forgot-link a {
            color: #6366f1;
            text-decoration: none;
            font-size: 14px;
        }
        .forgot-link a:hover { text-decoration: underline; }
        
        .login-toggle {
            text-align: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #333;
        }
        .login-toggle a {
            color: #ffd700;
            text-decoration: none;
            font-weight: bold;
        }
        .login-toggle a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="lang-toggle">
        <button onclick="toggleLang()" id="langBtn">Espa√±ol</button>
    </div>

    <!-- Step 1: Enter Class Code -->
    <div id="step1Screen" class="container">
        <div class="card">
            <div class="logo">üéì</div>
            <h1 data-i18n="studentPortal">Student Portal</h1>
            <p class="subtitle" data-i18n="welcomeMessage">Enter your class code to get started</p>
            
            <div class="steps">
                <div class="step active">1</div>
                <div class="step-line"></div>
                <div class="step">2</div>
                <div class="step-line"></div>
                <div class="step">3</div>
            </div>
            
            <div id="step1Error" class="message"></div>
            
            <div class="form-group">
                <label data-i18n="classCode">Class Code</label>
                <input type="text" id="classCode" class="code-input" placeholder="ABC123" maxlength="10">
            </div>
            
            <button onclick="validateCode()" id="validateBtn" data-i18n="continue">Continue</button>
            
            <div class="divider"><span data-i18n="or">or</span></div>
            
            <button class="btn-secondary" onclick="showLogin()" data-i18n="returningStudent">Returning Student? Login</button>
        </div>
    </div>

    <!-- Step 2: Create Account -->
    <div id="step2Screen" class="container hidden">
        <div class="card">
            <div class="logo">üìù</div>
            <h1 data-i18n="createAccount">Create Your Account</h1>
            <p class="subtitle" data-i18n="fillDetails">Fill in your details to register</p>
            
            <div class="steps">
                <div class="step done">‚úì</div>
                <div class="step-line done"></div>
                <div class="step active">2</div>
                <div class="step-line"></div>
                <div class="step">3</div>
            </div>
            
            <div class="class-info" id="classInfo">
                <h3 id="className">-</h3>
                <p><span data-i18n="slotsAvailable">Slots available:</span> <span id="slotsAvailable">-</span></p>
            </div>
            
            <div id="step2Error" class="message"></div>
            
            <div class="form-group">
                <label data-i18n="firstName">First Name</label>
                <input type="text" id="firstName" placeholder="Juan">
            </div>
            
            <div class="form-group">
                <label data-i18n="lastName">Last Name</label>
                <input type="text" id="lastName" placeholder="Garc√≠a">
            </div>
            
            <div class="form-group">
                <label data-i18n="username">Username</label>
                <input type="text" id="username" placeholder="juang2025">
            </div>
            
            <div class="form-group">
                <label data-i18n="password">Password</label>
                <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            
            <div class="form-group">
                <label data-i18n="gradeLevel">Grade Level</label>
                <select id="gradeLevel">
                    <option value="K">Kindergarten</option>
                    <option value="1">Grade 1</option>
                    <option value="2">Grade 2</option>
                    <option value="3">Grade 3</option>
                    <option value="4">Grade 4</option>
                    <option value="5">Grade 5</option>
                    <option value="6">Grade 6</option>
                    <option value="7">Grade 7</option>
                    <option value="8">Grade 8</option>
                    <option value="9">Grade 9</option>
                    <option value="10">Grade 10</option>
                    <option value="11">Grade 11</option>
                    <option value="12">Grade 12</option>
                </select>
            </div>
            
            <button onclick="registerStudent()" id="registerBtn" data-i18n="createAccount">Create Account</button>
            <button class="btn-secondary" onclick="goBack(1)" data-i18n="back">‚Üê Back</button>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="container hidden">
        <div class="card">
            <div class="logo">üîê</div>
            <h1 data-i18n="welcomeBack">Welcome Back!</h1>
            <p class="subtitle" data-i18n="loginMessage">Login to access your games</p>
            
            <div id="loginError" class="message"></div>
            
            <div class="form-group">
                <label data-i18n="username">Username</label>
                <input type="text" id="loginUsername" placeholder="juang2025">
            </div>
            
            <div class="form-group">
                <label data-i18n="password">Password</label>
                <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            
            <button onclick="loginStudent()" id="loginBtn" data-i18n="login">Login</button>
            
            <div class="forgot-link">
                <a href="password-reset.html" data-i18n="forgotPassword">Forgot Password?</a>
            </div>
            
            <div class="login-toggle">
                <span data-i18n="newStudent">New student?</span> 
                <a href="#" onclick="showStep1(); return false;" data-i18n="registerHere">Register here</a>
            </div>
        </div>
    </div>

    <!-- Step 3: Games Portal -->
    <div id="gamesScreen" class="container wide hidden">
        <div class="header">
            <h1>üéÆ <span data-i18n="cognitiveGames">Cognitive Training Games</span></h1>
        </div>
        
        <div class="user-bar">
            <div class="user-info">
                <div class="avatar-display" id="avatarDisplay" onclick="openAvatarModal()" title="Change Avatar">üòä</div>
                <div>
                    <div class="welcome"><span data-i18n="welcomeStudent">Welcome,</span> <span id="studentName">Student</span>!</div>
                    <div class="grade"><span data-i18n="grade">Grade</span>: <span id="studentGrade">-</span></div>
                </div>
            </div>
            <div class="user-actions">
                <button class="settings-btn" onclick="openSettingsModal()" title="Settings">‚öôÔ∏è</button>
                <button class="btn-secondary" onclick="logout()" data-i18n="logout">Logout</button>
            </div>
        </div>
        
        <!-- Streak Banner -->
        <div id="streakBanner" class="streak-banner hidden">
            <div class="flame">üî•</div>
            <div class="streak-info">
                <div class="streak-count"><span id="streakCount">0</span> <span data-i18n="dayStreak">day streak!</span></div>
                <div class="streak-label" data-i18n="keepItUp">Keep it up!</div>
            </div>
            <div class="streak-stats">
                <div><span data-i18n="longest">Longest</span>: <span id="longestStreak">0</span> <span data-i18n="days">days</span></div>
                <div><span data-i18n="totalDays">Total</span>: <span id="totalDays">0</span> <span data-i18n="days">days</span></div>
            </div>
        </div>
        
        <!-- Stats Bar -->
        <div class="stats-bar" id="statsBar">
            <div class="stat-item">
                <div class="value" id="statGames">0</div>
                <div class="label" data-i18n="gamesPlayed">Games Played</div>
            </div>
            <div class="stat-item">
                <div class="value" id="statMinutes">0</div>
                <div class="label" data-i18n="minutesPlayed">Minutes Played</div>
            </div>
            <div class="stat-item">
                <div class="value" id="statScore">0%</div>
                <div class="label" data-i18n="avgScore">Avg Score</div>
            </div>
            <div class="stat-item">
                <div class="value" id="statBadges">0</div>
                <div class="label" data-i18n="badges">Badges</div>
            </div>
        </div>
        
        <!-- Announcements Banner -->
        <div id="announcementsBanner" class="announcements-banner hidden"></div>
        
        <!-- Achievements Section -->
        <div id="achievementsSection" class="achievements-section">
            <h3>
                üèÜ <span data-i18n="achievements">Achievements</span>
                <span class="progress-text"><span id="achievementsEarned">0</span>/<span id="achievementsTotal">0</span></span>
            </h3>
            <div class="achievements-grid" id="achievementsGrid"></div>
        </div>
        
        <!-- Goals Progress -->
        <div id="goalsSection" class="goals-section hidden">
            <h3>üéØ <span data-i18n="yourGoals">Your Goals</span></h3>
            <div id="goalsList"></div>
        </div>
        
        <!-- Assignments -->
        <div id="assignmentsSection" class="assignments-section hidden">
            <h3>üìã <span data-i18n="assignedGames">Assigned Games</span></h3>
            <div id="assignmentsList"></div>
        </div>
        
        <!-- Game Mode Toggle -->
        <div class="mode-toggle">
            <button class="mode-btn active" id="scoredModeBtn" onclick="setGameMode('scored')">
                üèÜ <span data-i18n="scoredMode">Scored Mode</span>
            </button>
            <button class="mode-btn practice" id="practiceModeBtn" onclick="setGameMode('practice')">
                üéØ <span data-i18n="practiceMode">Practice Mode</span>
            </button>
        </div>
        <div class="mode-indicator scored" id="modeIndicator" data-i18n="scoredModeDesc">
            Your scores will be tracked and count toward achievements
        </div>
        
        <div class="filter-bar">
            <button class="filter-btn active" onclick="filterGames('all')" data-i18n="allGames">All Games</button>
            <button class="filter-btn" onclick="filterGames('K-2')">K-2</button>
            <button class="filter-btn" onclick="filterGames('3-5')">3-5</button>
            <button class="filter-btn" onclick="filterGames('6-8')">6-8</button>
            <button class="filter-btn" onclick="filterGames('9-12')">9-12</button>
        </div>
        
        <div class="games-grid" id="gamesGrid"></div>
    </div>
    
    <!-- Avatar Modal -->
    <div id="avatarModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üé≠ <span data-i18n="chooseAvatar">Choose Your Avatar</span></h2>
                <button class="modal-close" onclick="closeAvatarModal()">√ó</button>
            </div>
            <div class="avatar-grid" id="avatarGrid"></div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è <span data-i18n="settings">Settings</span></h2>
                <button class="modal-close" onclick="closeSettingsModal()">√ó</button>
            </div>
            <div class="settings-group">
                <label>
                    <span>üîä <span data-i18n="soundEffects">Sound Effects</span></span>
                    <div class="toggle">
                        <input type="checkbox" id="soundToggle" checked onchange="updateSettings()">
                        <span class="slider"></span>
                    </div>
                </label>
                <input type="range" class="volume-slider" id="soundVolume" min="0" max="100" value="80" onchange="updateSettings()">
            </div>
            <div class="settings-group">
                <label>
                    <span>üéµ <span data-i18n="backgroundMusic">Background Music</span></span>
                    <div class="toggle">
                        <input type="checkbox" id="musicToggle" onchange="updateSettings()">
                        <span class="slider"></span>
                    </div>
                </label>
                <input type="range" class="volume-slider" id="musicVolume" min="0" max="100" value="50" onchange="updateSettings()">
            </div>
            <button onclick="closeSettingsModal()" data-i18n="done">Done</button>
        </div>
    </div>

    <script>
    const API = 'https://akashic-academy-backend.onrender.com';
    let currentLang = 'en';
    let classCodeData = null;
    let studentData = null;
    let lockedGames = [];
    let currentGameMode = 'scored'; // 'scored' or 'practice'
    let studentSettings = { soundEnabled: true, musicEnabled: false, soundVolume: 80, musicVolume: 50 };
    let avatars = [];

    // Games data
    const games = [
        // K-2 Games
        { id: 'k2-sequence-memory', icon: 'üî¢', grade: 'K-2', 
          name: { en: 'Sequence Memory', es: 'Memoria de Secuencias' },
          desc: { en: 'Remember and repeat patterns', es: 'Recuerda y repite patrones' }
        },
        { id: 'k2-color-match', icon: 'üé®', grade: 'K-2',
          name: { en: 'Color Match', es: 'Combinar Colores' },
          desc: { en: 'Match colors quickly', es: 'Combina colores r√°pidamente' }
        },
        { id: 'k2-visual-memory', icon: 'üëÅÔ∏è', grade: 'K-2',
          name: { en: 'Visual Memory', es: 'Memoria Visual' },
          desc: { en: 'Remember what you see', es: 'Recuerda lo que ves' }
        },
        // 3-5 Games
        { id: '35-number-memory', icon: 'üî¢', grade: '3-5',
          name: { en: 'Number Memory', es: 'Memoria de N√∫meros' },
          desc: { en: 'Remember number sequences', es: 'Recuerda secuencias num√©ricas' }
        },
        { id: '35-visual-memory', icon: 'üëÅÔ∏è', grade: '3-5',
          name: { en: 'Visual Memory', es: 'Memoria Visual' },
          desc: { en: 'Remember visual patterns', es: 'Recuerda patrones visuales' }
        },
        { id: '35-word-search', icon: 'üî§', grade: '3-5',
          name: { en: 'Word Search', es: 'Sopa de Letras' },
          desc: { en: 'Find hidden words', es: 'Encuentra palabras ocultas' }
        },
        // 6-8 Games
        { id: '68-number-memory', icon: 'üî¢', grade: '6-8',
          name: { en: 'Number Memory', es: 'Memoria de N√∫meros' },
          desc: { en: 'Advanced number sequences', es: 'Secuencias num√©ricas avanzadas' }
        },
        { id: '68-typing-quiz', icon: '‚å®Ô∏è', grade: '6-8',
          name: { en: 'Typing Quiz', es: 'Quiz de Mecanograf√≠a' },
          desc: { en: 'Test your typing speed', es: 'Prueba tu velocidad de escritura' }
        },
        { id: '68-word-search', icon: 'üî§', grade: '6-8',
          name: { en: 'Word Search', es: 'Sopa de Letras' },
          desc: { en: 'Find challenging words', es: 'Encuentra palabras desafiantes' }
        },
        // 9-12 Games
        { id: '912-assessment', icon: 'üìä', grade: '9-12',
          name: { en: 'Cognitive Assessment', es: 'Evaluaci√≥n Cognitiva' },
          desc: { en: 'Complete cognitive test', es: 'Prueba cognitiva completa' }
        },
        { id: '912-stroop-challenge', icon: 'üß†', grade: '9-12',
          name: { en: 'Stroop Challenge', es: 'Desaf√≠o Stroop' },
          desc: { en: 'Test mental flexibility', es: 'Prueba flexibilidad mental' }
        },
        { id: '912-typing', icon: '‚å®Ô∏è', grade: '9-12',
          name: { en: 'Typing Test', es: 'Prueba de Mecanograf√≠a' },
          desc: { en: 'Professional typing test', es: 'Prueba de mecanograf√≠a profesional' }
        }
    ];

    // Translations
    const translations = {
        en: {
            studentPortal: 'Student Portal',
            welcomeMessage: 'Enter your class code to get started',
            classCode: 'Class Code',
            continue: 'Continue',
            or: 'or',
            returningStudent: 'Returning Student? Login',
            createAccount: 'Create Your Account',
            fillDetails: 'Fill in your details to register',
            slotsAvailable: 'Slots available',
            firstName: 'First Name',
            lastName: 'Last Name',
            username: 'Username',
            password: 'Password',
            gradeLevel: 'Grade Level',
            back: '‚Üê Back',
            welcomeBack: 'Welcome Back!',
            loginMessage: 'Login to access your games',
            login: 'Login',
            forgotPassword: 'Forgot Password?',
            newStudent: 'New student?',
            registerHere: 'Register here',
            cognitiveGames: 'Cognitive Training Games',
            welcomeStudent: 'Welcome,',
            grade: 'Grade',
            logout: 'Logout',
            allGames: 'All Games',
            play: 'Play',
            invalidCode: 'Invalid class code. Please check and try again.',
            codeFull: 'This class is full. Contact your teacher.',
            connectionError: 'Connection error. Please try again.',
            fillAllFields: 'Please fill in all fields.',
            usernameTaken: 'Username already taken. Try another.',
            registrationFailed: 'Registration failed. Please try again.',
            invalidLogin: 'Invalid username or password.',
            loginFailed: 'Login failed. Please try again.',
            // Assignments, Goals, Announcements
            yourGoals: 'Your Goals',
            assignedGames: 'Assigned Games',
            dueIn: 'Due:',
            completed: 'Completed!',
            gameLocked: 'Locked',
            // New features
            dayStreak: 'day streak!',
            keepItUp: 'Keep it up!',
            longest: 'Longest',
            totalDays: 'Total',
            days: 'days',
            gamesPlayed: 'Games Played',
            minutesPlayed: 'Minutes Played',
            avgScore: 'Avg Score',
            badges: 'Badges',
            achievements: 'Achievements',
            chooseAvatar: 'Choose Your Avatar',
            settings: 'Settings',
            soundEffects: 'Sound Effects',
            backgroundMusic: 'Background Music',
            done: 'Done',
            scoredMode: 'Scored Mode',
            practiceMode: 'Practice Mode',
            scoredModeDesc: 'Your scores will be tracked and count toward achievements',
            practiceModeDesc: 'Practice without affecting your stats'
        },
        es: {
            studentPortal: 'Portal del Estudiante',
            welcomeMessage: 'Ingresa tu c√≥digo de clase para comenzar',
            classCode: 'C√≥digo de Clase',
            continue: 'Continuar',
            or: 'o',
            returningStudent: '¬øYa tienes cuenta? Inicia sesi√≥n',
            createAccount: 'Crea tu Cuenta',
            fillDetails: 'Completa tus datos para registrarte',
            slotsAvailable: 'Cupos disponibles',
            firstName: 'Nombre',
            lastName: 'Apellido',
            username: 'Usuario',
            password: 'Contrase√±a',
            gradeLevel: 'Grado',
            back: '‚Üê Volver',
            welcomeBack: '¬°Bienvenido de Nuevo!',
            loginMessage: 'Inicia sesi√≥n para acceder a tus juegos',
            login: 'Iniciar Sesi√≥n',
            forgotPassword: '¬øOlvidaste tu contrase√±a?',
            newStudent: '¬øEres nuevo?',
            registerHere: 'Reg√≠strate aqu√≠',
            cognitiveGames: 'Juegos de Entrenamiento Cognitivo',
            welcomeStudent: 'Bienvenido,',
            grade: 'Grado',
            logout: 'Cerrar Sesi√≥n',
            allGames: 'Todos los Juegos',
            play: 'Jugar',
            invalidCode: 'C√≥digo inv√°lido. Por favor verifica e intenta de nuevo.',
            codeFull: 'Esta clase est√° llena. Contacta a tu maestro.',
            connectionError: 'Error de conexi√≥n. Por favor intenta de nuevo.',
            fillAllFields: 'Por favor completa todos los campos.',
            usernameTaken: 'El usuario ya existe. Intenta otro.',
            registrationFailed: 'Error al registrar. Por favor intenta de nuevo.',
            invalidLogin: 'Usuario o contrase√±a inv√°lidos.',
            loginFailed: 'Error al iniciar sesi√≥n. Por favor intenta de nuevo.',
            // Assignments, Goals, Announcements
            yourGoals: 'Tus Metas',
            assignedGames: 'Juegos Asignados',
            dueIn: 'Fecha:',
            completed: '¬°Completado!',
            gameLocked: 'Bloqueado',
            // New features
            dayStreak: '¬°d√≠as de racha!',
            keepItUp: '¬°Sigue as√≠!',
            longest: 'M√°s larga',
            totalDays: 'Total',
            days: 'd√≠as',
            gamesPlayed: 'Juegos Jugados',
            minutesPlayed: 'Minutos Jugados',
            avgScore: 'Puntaje Prom.',
            badges: 'Insignias',
            achievements: 'Logros',
            chooseAvatar: 'Elige tu Avatar',
            settings: 'Configuraci√≥n',
            soundEffects: 'Efectos de Sonido',
            backgroundMusic: 'M√∫sica de Fondo',
            done: 'Listo',
            scoredMode: 'Modo Puntuado',
            practiceMode: 'Modo Pr√°ctica',
            scoredModeDesc: 'Tus puntajes se registrar√°n y contar√°n para logros',
            practiceModeDesc: 'Practica sin afectar tus estad√≠sticas'
        }
    };

    function t(key) {
        return translations[currentLang][key] || translations['en'][key] || key;
    }

    function updateUI() {
        document.querySelectorAll('[data-i18n]').forEach(el => {
            el.textContent = t(el.dataset.i18n);
        });
        document.getElementById('langBtn').textContent = currentLang === 'en' ? 'Espa√±ol' : 'English';
    }

    function toggleLang() {
        currentLang = currentLang === 'en' ? 'es' : 'en';
        localStorage.setItem('lang', currentLang);
        updateUI();
        if (studentData) renderGames();
    }

    function showStep1() {
        document.getElementById('step1Screen').classList.remove('hidden');
        document.getElementById('step2Screen').classList.add('hidden');
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('gamesScreen').classList.add('hidden');
    }

    function showLogin() {
        document.getElementById('step1Screen').classList.add('hidden');
        document.getElementById('step2Screen').classList.add('hidden');
        document.getElementById('loginScreen').classList.remove('hidden');
        document.getElementById('gamesScreen').classList.add('hidden');
    }

    function goBack(step) {
        if (step === 1) showStep1();
    }

    async function validateCode() {
        const code = document.getElementById('classCode').value.trim().toUpperCase();
        const errorDiv = document.getElementById('step1Error');
        const btn = document.getElementById('validateBtn');
        
        if (!code) {
            errorDiv.className = 'message error';
            errorDiv.textContent = t('invalidCode');
            return;
        }
        
        btn.disabled = true;
        errorDiv.style.display = 'none';
        
        try {
            const r = await fetch(`${API}/api/class-codes/${code}/validate`);
            const data = await r.json();
            
            if (r.ok && data.valid) {
                classCodeData = data;
                document.getElementById('className').textContent = data.className || 'Class';
                document.getElementById('slotsAvailable').textContent = data.slotsRemaining;
                
                if (data.slotsRemaining <= 0) {
                    errorDiv.className = 'message error';
                    errorDiv.textContent = t('codeFull');
                } else {
                    document.getElementById('step1Screen').classList.add('hidden');
                    document.getElementById('step2Screen').classList.remove('hidden');
                }
            } else {
                errorDiv.className = 'message error';
                errorDiv.textContent = t('invalidCode');
            }
        } catch (e) {
            errorDiv.className = 'message error';
            errorDiv.textContent = t('connectionError');
        }
        
        btn.disabled = false;
    }

    async function registerStudent() {
        const firstName = document.getElementById('firstName').value.trim();
        const lastName = document.getElementById('lastName').value.trim();
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;
        const gradeLevel = document.getElementById('gradeLevel').value;
        const errorDiv = document.getElementById('step2Error');
        const btn = document.getElementById('registerBtn');
        
        if (!firstName || !lastName || !username || !password) {
            errorDiv.className = 'message error';
            errorDiv.textContent = t('fillAllFields');
            return;
        }
        
        btn.disabled = true;
        errorDiv.style.display = 'none';
        
        try {
            const r = await fetch(`${API}/api/students/register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    classCode: classCodeData.code,
                    firstName,
                    lastName,
                    username,
                    password,
                    gradeLevel
                })
            });
            
            const data = await r.json();
            
            if (r.ok) {
                studentData = data.student;
                localStorage.setItem('studentData', JSON.stringify(studentData));
                showGamesPortal();
            } else {
                errorDiv.className = 'message error';
                if (data.error?.includes('Username')) {
                    errorDiv.textContent = t('usernameTaken');
                } else {
                    errorDiv.textContent = data.error || t('registrationFailed');
                }
            }
        } catch (e) {
            errorDiv.className = 'message error';
            errorDiv.textContent = t('connectionError');
        }
        
        btn.disabled = false;
    }

    async function loginStudent() {
        const username = document.getElementById('loginUsername').value.trim();
        const password = document.getElementById('loginPassword').value;
        const errorDiv = document.getElementById('loginError');
        const btn = document.getElementById('loginBtn');
        
        if (!username || !password) {
            errorDiv.className = 'message error';
            errorDiv.textContent = t('fillAllFields');
            return;
        }
        
        btn.disabled = true;
        errorDiv.style.display = 'none';
        
        try {
            const r = await fetch(`${API}/api/students/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            
            const data = await r.json();
            
            if (r.ok) {
                studentData = data.student;
                localStorage.setItem('studentData', JSON.stringify(studentData));
                showGamesPortal();
            } else {
                errorDiv.className = 'message error';
                errorDiv.textContent = t('invalidLogin');
            }
        } catch (e) {
            errorDiv.className = 'message error';
            errorDiv.textContent = t('connectionError');
        }
        
        btn.disabled = false;
    }

    function showGamesPortal() {
        document.getElementById('step1Screen').classList.add('hidden');
        document.getElementById('step2Screen').classList.add('hidden');
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('gamesScreen').classList.remove('hidden');
        
        document.getElementById('studentName').textContent = studentData.firstName;
        document.getElementById('studentGrade').textContent = studentData.gradeLevel;
        
        // Load all student data
        loadAvatars();
        loadStudentStats();
        loadStreak();
        loadAchievements();
        loadSettings();
        loadAnnouncements();
        loadGoals();
        loadAssignments();
        loadGameLocks();
        
        renderGames();
    }

    // --- AVATARS ---
    async function loadAvatars() {
        try {
            const r = await fetch(`${API}/api/avatars`);
            avatars = await r.json();
        } catch (e) {
            avatars = [{ id: 'default', icon: 'üòä' }];
        }
        
        // Set current avatar
        const currentAvatar = studentData.avatar || 'default';
        const avatar = avatars.find(a => a.id === currentAvatar) || avatars[0];
        document.getElementById('avatarDisplay').textContent = avatar.icon;
    }

    function openAvatarModal() {
        const grid = document.getElementById('avatarGrid');
        const currentAvatar = studentData.avatar || 'default';
        
        grid.innerHTML = avatars.map(a => `
            <div class="avatar-option ${a.id === currentAvatar ? 'selected' : ''}" 
                 onclick="selectAvatar('${a.id}')">
                ${a.icon}
            </div>
        `).join('');
        
        document.getElementById('avatarModal').classList.add('show');
    }

    function closeAvatarModal() {
        document.getElementById('avatarModal').classList.remove('show');
    }

    async function selectAvatar(avatarId) {
        try {
            const r = await fetch(`${API}/api/students/${studentData.id}/avatar`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ avatarId })
            });
            
            if (r.ok) {
                const data = await r.json();
                studentData.avatar = avatarId;
                document.getElementById('avatarDisplay').textContent = data.icon;
                localStorage.setItem('studentData', JSON.stringify(studentData));
                
                // Update selection UI
                document.querySelectorAll('.avatar-option').forEach(opt => {
                    opt.classList.remove('selected');
                    if (opt.textContent.trim() === data.icon) {
                        opt.classList.add('selected');
                    }
                });
            }
        } catch (e) {
            console.error('Failed to update avatar:', e);
        }
        
        closeAvatarModal();
    }

    // --- SETTINGS ---
    async function loadSettings() {
        try {
            const r = await fetch(`${API}/api/students/${studentData.id}/settings`);
            studentSettings = await r.json();
            
            document.getElementById('soundToggle').checked = studentSettings.soundEnabled;
            document.getElementById('musicToggle').checked = studentSettings.musicEnabled;
            document.getElementById('soundVolume').value = studentSettings.soundVolume;
            document.getElementById('musicVolume').value = studentSettings.musicVolume;
        } catch (e) {
            // Use defaults
        }
    }

    function openSettingsModal() {
        document.getElementById('settingsModal').classList.add('show');
    }

    function closeSettingsModal() {
        document.getElementById('settingsModal').classList.remove('show');
    }

    async function updateSettings() {
        studentSettings = {
            soundEnabled: document.getElementById('soundToggle').checked,
            musicEnabled: document.getElementById('musicToggle').checked,
            soundVolume: parseInt(document.getElementById('soundVolume').value),
            musicVolume: parseInt(document.getElementById('musicVolume').value)
        };
        
        try {
            await fetch(`${API}/api/students/${studentData.id}/settings`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(studentSettings)
            });
        } catch (e) {
            console.error('Failed to save settings:', e);
        }
        
        // Store locally for games to use
        localStorage.setItem('gameSettings', JSON.stringify(studentSettings));
    }

    // --- STATS ---
    async function loadStudentStats() {
        try {
            const r = await fetch(`${API}/api/students/${studentData.id}/stats`);
            const stats = await r.json();
            
            document.getElementById('statGames').textContent = stats.gamesCompleted;
            document.getElementById('statMinutes').textContent = stats.totalMinutes;
            document.getElementById('statScore').textContent = stats.averageScore + '%';
            document.getElementById('statBadges').textContent = stats.achievementsEarned;
            
            // Update avatar if returned
            if (stats.avatarIcon) {
                document.getElementById('avatarDisplay').textContent = stats.avatarIcon;
            }
        } catch (e) {
            // Defaults shown
        }
    }

    // --- STREAK ---
    async function loadStreak() {
        const banner = document.getElementById('streakBanner');
        
        try {
            // First update streak (records today's login)
            await fetch(`${API}/api/students/${studentData.id}/streak`, { method: 'POST' });
            
            // Then get streak data
            const r = await fetch(`${API}/api/students/${studentData.id}/streak`);
            const streak = await r.json();
            
            if (streak.currentStreak > 0) {
                document.getElementById('streakCount').textContent = streak.currentStreak;
                document.getElementById('longestStreak').textContent = streak.longestStreak;
                document.getElementById('totalDays').textContent = streak.totalDays;
                banner.classList.remove('hidden');
            } else {
                banner.classList.add('hidden');
            }
        } catch (e) {
            banner.classList.add('hidden');
        }
    }

    // --- ACHIEVEMENTS ---
    async function loadAchievements() {
        const section = document.getElementById('achievementsSection');
        const grid = document.getElementById('achievementsGrid');
        
        try {
            // Check for new achievements first
            await fetch(`${API}/api/students/${studentData.id}/check-achievements`, { method: 'POST' });
            
            // Get all achievements
            const r = await fetch(`${API}/api/students/${studentData.id}/achievements`);
            const data = await r.json();
            
            document.getElementById('achievementsEarned').textContent = data.earned;
            document.getElementById('achievementsTotal').textContent = data.total;
            
            grid.innerHTML = data.achievements.map(a => `
                <div class="achievement-item ${a.earned ? 'earned' : ''}" title="${a.desc[currentLang]}">
                    <div class="icon">${a.icon}</div>
                    <div class="name">${a.name[currentLang]}</div>
                    <div class="desc">${a.desc[currentLang]}</div>
                </div>
            `).join('');
            
            section.classList.remove('hidden');
        } catch (e) {
            section.classList.add('hidden');
        }
    }

    // --- GAME MODE ---
    function setGameMode(mode) {
        currentGameMode = mode;
        
        document.getElementById('scoredModeBtn').classList.toggle('active', mode === 'scored');
        document.getElementById('practiceModeBtn').classList.toggle('active', mode === 'practice');
        
        const indicator = document.getElementById('modeIndicator');
        indicator.className = `mode-indicator ${mode}`;
        indicator.textContent = t(mode === 'scored' ? 'scoredModeDesc' : 'practiceModeDesc');
        
        // Store mode for games
        localStorage.setItem('gameMode', mode);
    }

    async function loadAnnouncements() {
        const banner = document.getElementById('announcementsBanner');
        
        try {
            const r = await fetch(`${API}/api/students/${studentData.id}/announcements`);
            const announcements = await r.json();
            
            if (announcements.length === 0) {
                banner.classList.add('hidden');
                return;
            }
            
            const hasHigh = announcements.some(a => a.priority === 'high');
            banner.className = `announcements-banner ${hasHigh ? 'high' : ''}`;
            
            banner.innerHTML = announcements.map(a => `
                <div class="announcement-item">
                    <div class="title">${a.priority === 'high' ? '‚ö†Ô∏è ' : 'üì¢ '}${a.title}</div>
                    <div class="message">${a.message}</div>
                </div>
            `).join('');
            
            banner.classList.remove('hidden');
        } catch (e) {
            banner.classList.add('hidden');
        }
    }

    async function loadGoals() {
        const section = document.getElementById('goalsSection');
        const list = document.getElementById('goalsList');
        
        try {
            const r = await fetch(`${API}/api/students/${studentData.id}/goals`);
            const goals = await r.json();
            
            if (goals.length === 0) {
                section.classList.add('hidden');
                return;
            }
            
            const typeLabels = {
                games_completed: { en: 'Complete games', es: 'Completar juegos' },
                minutes_played: { en: 'Play minutes', es: 'Minutos jugados' },
                score_average: { en: 'Average score', es: 'Puntaje promedio' },
                streak_days: { en: 'Days played', es: 'D√≠as jugados' }
            };
            
            list.innerHTML = goals.map(g => {
                const isCompleted = g.progress.completed;
                return `
                    <div class="goal-item">
                        <div class="goal-header">
                            <div class="goal-title">${g.title}</div>
                            <div class="goal-status ${isCompleted ? 'completed' : ''}">
                                ${isCompleted ? t('completed') : `${g.progress.current} / ${g.target}`}
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="fill ${isCompleted ? 'completed' : ''}" style="width: ${g.progress.percentage}%"></div>
                        </div>
                        <div style="font-size:12px; color:#888; margin-top:8px;">
                            ${typeLabels[g.type][currentLang]} ‚Ä¢ Ends: ${new Date(g.endDate).toLocaleDateString()}
                        </div>
                    </div>
                `;
            }).join('');
            
            section.classList.remove('hidden');
        } catch (e) {
            section.classList.add('hidden');
        }
    }

    async function loadAssignments() {
        const section = document.getElementById('assignmentsSection');
        const list = document.getElementById('assignmentsList');
        
        try {
            const r = await fetch(`${API}/api/students/${studentData.id}/assignments`);
            const assignments = await r.json();
            
            if (assignments.length === 0) {
                section.classList.add('hidden');
                return;
            }
            
            list.innerHTML = assignments.map(a => {
                const gamesHtml = a.gameIds.map(gameId => {
                    const game = games.find(g => g.id === gameId);
                    const isCompleted = a.progress.completedGames.includes(gameId);
                    return `
                        <div class="assignment-game ${isCompleted ? 'completed' : ''}" onclick="playGame('${gameId}')">
                            ${game ? game.icon : 'üéÆ'} ${game ? game.name[currentLang] : gameId}
                            ${isCompleted ? '<span class="checkmark">‚úì</span>' : ''}
                        </div>
                    `;
                }).join('');
                
                return `
                    <div class="assignment-item">
                        <div class="assignment-header">
                            <div class="assignment-title">${a.title}</div>
                            ${a.dueDate ? `<div class="due-date">${t('dueIn')} ${new Date(a.dueDate).toLocaleDateString()}</div>` : ''}
                        </div>
                        <div class="assignment-games">${gamesHtml}</div>
                        <div style="font-size:12px; color:#888; margin-top:10px;">
                            ${a.progress.completed} / ${a.progress.total} ${t('completed')}
                        </div>
                    </div>
                `;
            }).join('');
            
            section.classList.remove('hidden');
        } catch (e) {
            section.classList.add('hidden');
        }
    }

    async function loadGameLocks() {
        try {
            const r = await fetch(`${API}/api/students/${studentData.id}/available-games`);
            const data = await r.json();
            lockedGames = data.lockedGames || [];
        } catch (e) {
            lockedGames = [];
        }
    }

    function renderGames(filter = 'all') {
        const grid = document.getElementById('gamesGrid');
        const lang = currentLang;
        
        const filtered = filter === 'all' ? games : games.filter(g => g.grade === filter);
        
        grid.innerHTML = filtered.map(game => {
            const isLocked = lockedGames.includes(game.id);
            return `
                <div class="game-card ${isLocked ? 'locked' : ''}">
                    <div class="icon">${game.icon}</div>
                    <div class="grade-badge">${game.grade}</div>
                    <h3>${game.name[lang]}</h3>
                    <p>${game.desc[lang]}</p>
                    ${isLocked 
                        ? `<button class="btn-secondary" disabled>üîí ${t('gameLocked')}</button>`
                        : `<button class="btn-play" onclick="playGame('${game.id}')">${t('play')}</button>`
                    }
                </div>
            `;
        }).join('');
    }

    function filterGames(grade) {
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        renderGames(grade);
    }

    async function playGame(gameId) {
        // Check if game is locked
        if (lockedGames.includes(gameId)) {
            alert(t('gameLocked'));
            return;
        }
        
        // Start a game session
        try {
            const r = await fetch(`${API}/api/game-sessions/start`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    studentId: studentData.id,
                    gameId,
                    mode: currentGameMode
                })
            });
            
            if (r.ok) {
                const session = await r.json();
                // Store session info for game to use
                localStorage.setItem('currentSession', JSON.stringify({
                    sessionId: session.sessionId,
                    mode: session.mode,
                    gameId,
                    studentId: studentData.id
                }));
            }
        } catch (e) {
            console.error('Failed to start session:', e);
        }
        
        const lang = currentLang === 'es' ? 'es' : 'en';
        const url = `${API}/games/${gameId}-${lang}.html`;
        window.open(url, '_blank');
    }

    function logout() {
        localStorage.removeItem('studentData');
        studentData = null;
        showStep1();
    }

    // Enter key handlers
    document.getElementById('classCode').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') validateCode();
    });
    document.getElementById('loginPassword').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') loginStudent();
    });

    // Initialize
    window.onload = function() {
        const savedLang = localStorage.getItem('lang');
        if (savedLang) currentLang = savedLang;
        updateUI();
        
        // Check for saved session
        const saved = localStorage.getItem('studentData');
        if (saved) {
            try {
                studentData = JSON.parse(saved);
                showGamesPortal();
            } catch (e) {
                localStorage.removeItem('studentData');
            }
        }
    };
    </script>
</body>
</html>
